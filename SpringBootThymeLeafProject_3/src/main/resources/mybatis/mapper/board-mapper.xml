<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sist.web.mapper.BoardMapper">
  <select id="boardListData" resultType="com.sist.web.vo.BoardVO" parameterType="hashmap">
    SELECT no, name, subject, TO_CHAR(regdate, 'YYYY-MM-DD') AS dbday, hit, group_tab, num
    FROM (SELECT no, name, subject, regdate, hit, group_tab, ROWNUM AS num
    FROM (SELECT no, name, subject, regdate, hit, group_tab
    FROM springReplyBoard ORDER BY group_id DESC, group_step ASC))
    WHERE num BETWEEN #{start} AND #{end}
  </select>
  
  <select id="boardRowCount" resultType="int">
    SELECT COUNT(*) FROM springReplyBoard
  </select>
  
  <insert id="boardInsert" parameterType="com.sist.web.vo.BoardVO">
    INSERT INTO springReplyBoard(no, name, subject, content, pwd, group_id)
    VALUES(srb_no_seq.nextval, #{name}, #{subject}, #{content}, #{pwd},
    	(SELECT NVL(MAX(group_id)+1, 1) FROM springReplyBoard))
  </insert>
  
  <!-- 상세보기 -->
  <update id="boardHitIncrement" parameterType="int">
    UPDATE springReplyBoard SET
    hit = hit+1
    WHERE no = #{no}
  </update>
  
  <select id="boardDetailData" resultType="com.sist.web.vo.BoardVO" parameterType="int">
    SELECT no, name, subject, content, hit, TO_CHAR(regdate, 'YYYY-MM-DD HH24:MI:SS') AS dbday
    FROM springReplyBoard
    WHERE no = #{no}
  </select>
  
  <!-- 답변 -->
  <!-- 1. 상위 게시물의 정보 : group관련 -->
  <select id="boardParentInfoData" resultType="com.sist.web.vo.BoardVO" parameterType="int">
    SELECT group_id, group_step, group_tab
    FROM springReplyBoard
    WHERE no = #{no}
  </select>
  <!-- 2. group_step 증가 -->
  <update id="boardGroupStepIncrement" parameterType="com.sist.web.vo.BoardVO">
    UPDATE springReplyBoard SET
    group_step = group_step+1
    WHERE group_id = #{group_id} AND group_step>#{group_step}
  </update>
  <!-- 3. 데이터 추가 -->
  <insert id="boardReplyInsert" parameterType="com.sist.web.vo.BoardVO">
    INSERT INTO springReplyBoard(no, name, subject, content, pwd, group_id, group_step, group_tab, root)
    VALUES(srb_no_seq.nextval, #{name}, #{subject}, #{content}, #{pwd}, #{group_id}, #{group_step}, #{group_tab}, #{root})
  </insert>
  <!-- 4. depth 증가 -->
  <update id="boardDepthIncrement" parameterType="int">
    UPDATE springReplyBoard SET
    depth = depth+1
    WHERE no = #{no}
  </update>
  
  <!-- 수정 : Vue연동 -->
  <select id="boardGetPassword" resultType="string" parameterType="int">
    SELECT pwd FROM springReplyBoard
    WHERE no = #{no}
  </select>
  
  <update id="boardUpdate" parameterType="com.sist.web.vo.BoardVO">
    UPDATE springReplyBoard SET
    name = #{name}, subject = #{subject}, content = #{content}
    WHERE no = #{no}
  </update>
  
  <!-- 삭제 : Vue연동 -->
  <!-- depth, root 가져오기 -->
  <select id="boardDeleteInfoData" resultType="com.sist.web.vo.BoardVO" parameterType="int">
    SELECT depth, root FROM springReplyBoard
    WHERE no = #{no}
  </select>
  <!-- 삭제된 글 출력메시지 변경 -->
  <update id="boardSubjectChange" parameterType="int">
    UPDATE springReplyBoard SET
    subject = '이미 삭제된 게시글입니다',
    content = '이미 삭제된 게시글입니다'
    WHERE no = #{no}
  </update>
  <!-- 실제 삭제 -->
  <delete id="boardDelete" parameterType="int">
    DELETE FROM springReplyBoard
    WHERE no = #{no}
  </delete>
  <!-- depth 감소 -->
  <update id="boardDepthDecrement" parameterType="int">
    UPDATE springReplyBoard SET
    depth = depth-1
    WHERE no = #{no}
  </update>
</mapper>